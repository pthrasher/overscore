(function(){var buildIdentifier,fs,getAllFiles,log,nonos,path,program,removeByteOrderMark,slugify,startsWith,templateSrc,version,_;_=require("underscore"),fs=require("fs"),log=require("npmlog"),path=require("path"),program=require("commander"),version=require("./package.json").version,removeByteOrderMark=function(text){return text.charCodeAt(0)===65279?text.substring(1):text},slugify=function(text){var nono,_i,_len;for(_i=0,_len=nonos.length;_i<_len;_i++)nono=nonos[_i],text=text.replace(nono,"");return text},templateSrc=function(html){var compiled;return compiled=_.template(html),compiled.source.replace(/\n+/g,"")},getAllFiles=function(fsPaths,re){var files,fsPath,handleFile,realPath,stats,_file,_files,_fsPath,_fsPaths,_i,_j,_k,_len,_len1,_len2;re==null&&(re=null),log.verbose("fsPaths",fsPaths),files=[];for(_i=0,_len=fsPaths.length;_i<_len;_i++){fsPath=fsPaths[_i],log.verbose("fsPath",fsPath),stats=fs.statSync(fsPath);if(stats.isDirectory()){_fsPaths=fs.readdirSync(fsPath),log.verbose("_fsPaths",_fsPaths);for(_j=0,_len1=_fsPaths.length;_j<_len1;_j++){_fsPath=_fsPaths[_j],realPath=path.join(fsPath,_fsPath),log.verbose("realPath",realPath),_files=getAllFiles([realPath]);for(_k=0,_len2=_files.length;_k<_len2;_k++)_file=_files[_k],files.push(_file)}}else stats.isFile()&&(handleFile=!0,re!=null?fsPath.match(re)&&files.push(fsPath):files.push(fsPath))}return files},startsWith=function(needle,haystack){return haystack.indexOf(needle)===0},buildIdentifier=function(filePath){var basename,cleanPath,extname,identifier,identifierParts,newPart,part,slug,_i,_len,_ref;cleanPath=filePath,program.basedir&&startsWith(program.basedir,cleanPath)&&(cleanPath=cleanPath.replace(program.basedir,""),cleanPath.indexOf("/")===0&&(cleanPath=cleanPath.slice(1))),extname=path.extname(cleanPath),basename=path.basename(cleanPath,extname),log.verbose("cleanPath",cleanPath),log.verbose("basename",basename),slug=slugify(basename);if(cleanPath.indexOf("/")===-1)identifier=""+program.namespace+"."+slug;else{identifierParts=[program.namespace],_ref=path.dirname(cleanPath).split("/");for(_i=0,_len=_ref.length;_i<_len;_i++)part=_ref[_i],newPart=slugify(part),newPart.length&&identifierParts.push(newPart);identifierParts.push(slug),identifier=identifierParts.join(".")}return identifier},nonos=["`","~","!","@","#","$","%","^","&","*","(",")","_","+","-","=","[","]","{","}","\\","|",";",":","'",'"',",","<",".",">","/","?"],exports.main=function(args){var i,id,indent,item,nsParts,templates,topNS,_i,_len;program.version(version).usage("[options] <files ...>").option("-s, --silent","Shortcut for --loglevel silent.").option("-a, --amd","Wrap output with define to make it AMD compatible.").option("-n, --namespace <namespace>","Namespace under which templates should live. [Templates]",String,"Templates").option("-l, --loglevel <level>","Minimum log level to display. [info]",String,"info").option("-b, --basedir <basedir>","Base directory to keep out of namespacing.").parse(args),log.level=program.loglevel,program.silent&&(log.level="silent"),log.verbose("options",program.args.length),program.args.length||(log.verbose("options","You didn't specify any files."),console.log(program.helpInformation()),program.emit("--help"),process.exit(1)),log.verbose("args",args),log.verbose("args",program.args),templates=getAllFiles(program.args).map(function(filePath){var contents,identifier,line,name,src;log.verbose("filePath",filePath),name=slugify(path.basename(filePath,path.extname(filePath))),contents=fs.readFileSync(filePath,"utf8"),contents=removeByteOrderMark(contents.trim());if(contents==null){log.error(name,"Could not read file contents, skipping. ["+filePath+"]");return}return identifier=buildIdentifier(filePath),src=templateSrc(contents),line=""+identifier+" = "+src+";",log.info("compiled","["+filePath+"] "+identifier),line}),templates=templates.filter(function(template){return template});if(templates.length){indent="",program.amd&&(program.namespace.indexOf(".")>-1?console.log("define('"+program.namespace.split(".").join("/")+"', function() {"):console.log("define('"+program.namespace+"', function() {"),indent="    "),console.log(""+indent+"/*\n"+indent+" * Safely grab the namespace(s).\n"+indent+" */");if(program.namespace.indexOf(".")>-1){nsParts=program.namespace.split(".");for(i=_i=0,_len=nsParts.length;_i<_len;i=++_i)item=nsParts[i],i===0?(topNS=item,console.log(""+indent+"var "+item+" = "+item+" != null ? "+item+" : {};")):(id=nsParts.slice(0,i+1||9e9).join("."),console.log(""+indent+id+" = "+id+" != null ? "+id+" : {};"))}else topNS=program.namespace,console.log(""+indent+"var "+program.namespace+" = "+program.namespace+" != null ? "+program.namespace+" : {};");console.log("\n"+indent+"/*\n"+indent+" * Individual templates.\n"+indent+" */"),console.log(""+indent+templates.join("\n"+indent));if(program.amd)return console.log(""+indent+"return "+topNS+";"),console.log("});")}}}).call(this)